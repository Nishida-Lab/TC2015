%
% 計測自動制御学会システム・インテグレーション部門学術講演会2012原稿サンプルファイル
%                                           October 4, 2012
% Based on 計測自動制御学会システム・情報部門学術講演会2012原稿サンプルファイル
%                                           April 28, 2012
% Based on 第7回計測自動制御学会制御部門大会原稿サンプルファイル
%                                           October 18, 2007
% Based on 第5回計測自動制御学会制御部門大会原稿サンプルファイル
%            近野敦 konno@space.mech.tohoku.ac.jp    March 05, 2005
%

\documentclass[10pt,a4paper]{jarticle}
\usepackage{tc2015_utf}
\usepackage[dvipdfmx]{graphicx,color}
\usepackage[fleqn]{amsmath}
\usepackage{algorithm,algorithmic}
\usepackage{amssymb,epsfig}
\usepackage{ascmac}

\usepackage{url}
\usepackage{bm}
\usepackage{ascmac}
\usepackage{pifont}
%\usepackage{multirow}
\usepackage{enumerate}
%\usepackage{cases}
\usepackage{type1cm}
\usepackage{here}

\def\vec#1{\mbox{\boldmath$#1$}}
\def\vector#1{\mbox{\boldmath $#1$}}

\newcommand{\argmax}{\mathop{\rm arg~max}\limits}
\newcommand{\argmin}{\mathop{\rm arg~min}\limits}
\newcommand{\umax}{\mathop{\rm max}\limits}

\def\R{{\Bbb R}}
\def\Z{{\Bbb Z}}

\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\dbltopfraction}{0.8}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.8}
\renewcommand{\dblfloatpagefraction}{0.8}
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{3}
\setcounter{totalnumber}{3}

\begin{document}
\title{\fontsize{16pt}{0pt}\selectfont 九州工業大学CIR-KITのつくばチャレンジへの取り組み}
\author{\fontsize{12pt}{0pt} 有田 裕太（九州工業大学）~ 田中 良道（九州工業大学） \\ ~ 森田 賢（九州工業大学）~西田 健（九州工業大学）}
\engtitle{
   \fontsize{16pt}{40pt}\selectfont 
}
\engauthor{
  \fontsize{12pt}{0pt}\selectfont Arita Yuta(Kyutech), Tanaka Ryodo(Kyutech), \\ Morita Masaru(Kyutech) and Nishida Takeshi(Kyutech)
}

\abstract{
\fontsize{9pt}{0pt}\selectfont
}

\maketitle\thispagestyle{empty}
\pagestyle{empty}

\section{はじめに}
\label{sec:intro}
我々は，九州工業大学工学部の学部生を中心としたロボット開発チームであり，屋内外の移動を行う福祉ロボットの開発に取り組んでいる．このような福祉ロボットに必要とされる機能には，案内・荷物の運搬・搭乗者の安全な搬送・周囲環境に対する回避，発見，追従動作などが挙げられる．そこで我々は市販の電動カートを改造し，これらの作業を行うための福祉ロボット(KIT-C3)を開発した．しかし，このロボットでは屋内を走行するには大きすぎるため，比較的小さく，小回りもきくロボット(KIT-C4)の開発を行った．本稿では，これらのロボットの開発とつくばチャレンジ2015での実験結果について報告する．

\section{ロボットの構成}
\subsection{KIT-C3}
\subsubsection{ハードウェア構成}
本ロボットでは，シニアカータウンカート(スズキ株式会社製TC1A4)の走行系を用いた．シニアカーの走行系は，バッテリーや走行安定性，防水性など，様々な面で屋外での走行機能の信頼性が高く，故障などの問題の発生率が低い．さらに，ホイールレングスが1[m]程度あるため，直進走行性能が高く，自動走行制御に対して再現性が高いというアドバンテージがある．一方で，つくばチャレンジの他チームの小型走行ロボットよりは比較的車体が大きく，車重も97[kg]と重い．Fig.\ref{213021_18Dec14}にKIT-C3の外観を示す．

\begin{figure}
  \centering
  \includegraphics[width=7cm]{fig/eps/kitc3.eps}
  \caption{KIT-C3の外観}
  \label{213021_18Dec14}
\end{figure}

\subsubsection{センサ構成}
KIT-C3は環境観測用センサとして前方にLRF(北陽電機製UTM-30LX)を2台，後方にも同様のLRFを1台搭載している．また，ロボットの状態観測用センサとしてロータリーエンコーダ(MUTOH製UM-125)をステアリング軸に1つ取り付けている．このセニアカーの後輪は独立に2つのモータとエンコーダが搭載されており，そのエンコーダ情報をマイコンにより取得している．

\subsubsection{全体の構成}
ロボットへの速度指令やロータリーエンコーダの処理用マイコンとして iXs Research 社のiMCs01を用いた．シニアカーの速度制御はiMCs01で0-5[V]の電圧を生成しシニアカーのアクセル信号部に印加することで実現している．またステアリング操舵のためステッピングモータの制御にArduino Unoを用いた．制御用PCはラップトップPCを用いており，OSはUbuntu 14.04を使用した．以上の構成の概要をFig.\ref{225251_18Dec14}に示す．ラップトップPCとiMCs01やURGとはUSB接続である．また，Fig.\ref{213021_18Dec14}における破線はシニアカーの制御基板によって制御されていることを表す．

\begin{figure}[tbp]
  \centering
  \includegraphics[width=6cm]{fig/eps/kitc3_overview.eps}
  \caption{KIT-C3のシステムの概要}
  \label{225251_18Dec14}
\end{figure}

\subsection{KIT-C4}
\subsubsection{はじめに}
本年度のつくばチャレンジにおいてKIT-C4の開発を行ったが，予算不足や開発人員の不足により，実際につくばチャレンジの実験走行や本走行を行うことはなかった．よって本稿におけるKIT-C4についての記述はすべて開発途中の成果であり，開発の経験，知識を共有することを目的としていることに留意されたい．

\subsubsection{ハードウェア構成}
KIT-C4は，KIT-C3と比べて小型化，旋回性能の向上を図り製作した独立二輪駆動方式のロボットである．実際のロボットをFig.\ref{KIT_C4_hard}に示す．KIT-C4は昨年度より開発を行っている．ゆえに本年度追加，変更した要素について述べる．まず追加要素について，本年度は車載PCと無線LANハブを新たに搭載した．これは，ROS\footnote{Robot Operating System の略称．なお，用いたバージョンはIndigoである．}を用いた分散処理を行うためである．車載PCでロボットの走行制御とセンサ情報処理を行い，走行プランナなどの上位層のアプリケーションを実行するPCと分散処理を行う．続いて変更要素について，昨年度スイッチボックスを作成したが，Fig.\ref{KIT_C4_box}に示すように，ボックスの取り付け位置に問題があり，配線の取り回しが非常に複雑になってしまった．そこで本年度は，ボックスの取り付け位置を変更し，配線の取り回しを行いやすくした．これによりこれまで無駄に使用していた空間を確保することができ，遠隔操縦コントローラ等の設置スペースを設けることができた．

\begin{figure}[tbp]
  \centering
  \includegraphics[width=8cm]{fig/eps/KIT_C4_hard.eps}
  \caption{KIT-C4の外観}
  \label{KIT_C4_hard}
\end{figure}

\begin{figure}[tbp]
  \centering
  \includegraphics[width=6cm]{fig/eps/KIT_C4_box.eps}
  \caption{KIT-C4のスイッチボックス}
  \label{KIT_C4_box}
\end{figure}


\subsubsection{センサ構成}
KIT-C4は昨年度と同様，環境観測用センサとして前方下方にLRF（北陽電機製 UTM-30LX-EW）を，前方上方にLRFと陽動機構（移動ロボット研究所製 Gim30°）を組み合わせた3次元LiDARを搭載している．また，ホイールオドメトリ観測のため，駆動輪にそれぞれロータリーエンコーダ（オムロン製 E6B2-CWZ60）を設置した．これらのセンサに加えて，本年度はGPS（Hemisphere A100）を追加で搭載した．このGPSは本年度開発した自律走行計画に用いることは予定していないが，センサ系に冗長性を持たせることで，他のセンサが故障し，替えが効かない際に用いることを想定している．

\subsubsection{システム概要}
KIT-C4のシステム概要をFig.\ref{KIT_C4_system}に示す．先述のとおり，ロボットの走行制御，センサ情報処理は車載PCで行い，このPCをROSのMASTERとしている．この車載PCに走行計画を行うPCを，クライアントPCとしてEthernet経由で接続する．これにより走行計画などの比較的リソースを必要とするプログラムに十分な駆動環境を与えることができ，走行の安定化を図ることができる．尚，後ほど紹介するROSの走行プランナーについては，リソースが不足するとロボットの走行の安定性に大きな悪影響を及ぼすことが実験を行う中で判明している．よって，このような分散処理は，つくばチャレンジのような走行の確実性を求められる大会において非常に有効な手段であると考えられる．

\begin{figure}[tbp]
  \centering
  \includegraphics[width=6cm]{fig/eps/KIT_C4_system.eps}
  \caption{KIT-C4のシステム概要}
  \label{KIT_C4_system}
\end{figure}

\subsubsection{モータについて}
KIT-C4の駆動モータには昨年度と同様，三相ブラシレスモータ（オリエンタルモータ製 BLH230K-30）を使用した．昨年度の開発において，これに付属するモータドライバがロボットの速度制御に適していないことが判明しており，ドライバの変更を行うことを考えていた．しかし，予算の都合より，ドライバを交換することが不可能であったため，昨年度と同様，モータドライバへの入力値を制御することで，走行の安定化を図った．付属のモータドライバは速度制御を行うものであり，0〜5[V]のPWM信号に合わせてモータの回転速度を制御するようなドライバである．昨年度まではこのドライバに対し，試行錯誤によりif・then形式のプログラムを作成していた．昨年度の走行の結果，低速時には比較的安定して走行することが判明している．しかし本年度はハードウェア構成の変更があり，再び試行錯誤を繰り返す時間が無かったため，よりシステマティックな制御器を構築することを目標とした．また，昨年度はロボットの走行時にブレーキ動作が多かった（目標値＋閾値を超える速度になるとブレーキ動作を行うようなアルゴリズムであった）ため，オーバーシュートをなるべく少なくすることも目標とした．そこで本年度はI-P制御を用いることとした．I-P制御では，積分要素に偏差を，比例要素に観測値を用いるようなフィードバック制御であり，目標値が急激に変化しても制御値が急激に変化しづらいため，オーバーシュートが起きづらいという特徴がある．I-P制御について，Fig.\ref{KIT_C4_i-pcontrol}に制御システムのブロック線図を示す．ただし，図中の$r$は目標速度を，$u$は制御入力を，$y$は観測値を表し，$k_p$は比例ゲインを，$k_i$は積分ゲインを表す．また，目標速度$r$に対し，制御入力$u$がPWM信号，出力$y$が駆動輪に取り付けたロータリーエンコーダの観測値となるようなシステムを制御対象とした．I-P制御を行うには制御対象の同定が必要であるので，システムを二次遅れ系としてステップ同定を行った．制御器を取り付けた結果，平坦な道を走行する際にはオーバーシュートの少ない，安定した走行を行うことができたが，坂道では不安定な走行となってしまった．これは，坂道を走行しているロボットのモデルが同定したモデルとは異なるために起きた現象である．ゆえに予め同定したモデルを用いた制御を行うのではなく，モデルをオンラインで推定し，推定したモデルに対して制御を行う必要がある．I-P制御の採用を決定した際には，無視できるほどのモデル化誤差であると予想していたが，これが間違いであることがわかった．以上より，モータドライバを変更しないのであれば，オブザーバを用いた状態フィードバック制御やモデル予測制御など，よりロバストな制御を行うことでこれらの問題に対処できるものと考えられる．

\begin{figure}[tbp]
  \centering
  \includegraphics[width=7cm]{fig/eps/KIT_C4_i-pcontrol.eps}
  \caption{I-Pコントローラ}
  \label{KIT_C4_i-pcontrol}
\end{figure}


\section{ソフトウェアの構成}
\subsection{ROS}
開発したロボットには先述のとおりROSを導入している．これはソフトウェアの再利用性を意識したものである．実際，KIT-C3で開発したソフトウェアをKIT-C4で再利用することが可能であり，開発時間の短縮を図ることができる．また，ROSを用いることでデバッグや可視化に有効なツールだけでなく，世界中の開発者が作成したライブラリを容易に利用することができる．ゆえに我々は，ソフトウェア構成においてROSを採用した．
\subsection{走行手法}
走行手法には，ROSのnavigationスタックを利用した．予め環境地図を作成し，環境地図上にWaypointを数メートル毎に設定し，それらを順に辿っていくようにして自律移動を行った．Waypointの設定はROSの可視化ソフトウェアrviz上でクリックやドラッグ操作で設定できるパッケージを開発しこれを用いた．経路生成および障害物回避にはmove\_baseパッケージを用いた．また，自己位置推定にはAMCL（AdaptiveMontecalro Localization)を用いた．昨年は前方下に取り付けた1台のLRFで自己位置推定を行っていたが，今年は前方と後方に取り付けた2台のLRFで自己位置推定を行った．

\subsection{環境地図}
環境地図はROSのパッケージ化されたgmappingを用いて作成した．環境地図は10[cm]四方の占有格子地図とした．環境地図作成に用いたセンサは昨年はLRF1台とホイールオドメトリのみであったが，今年は自己位置推定同様に前方と後方に取り付けた2台のLRFとホイールオドメトリを利用して作成した．これにより大清水公園などでも比較的精度の高い地図を短時間で作成することができた．また，確認走行を完了したあとは大清水公園と公園の外でそれぞれ地図を作成し画像編集ソフトを用いて1つに統合したものを用いた．作成した地図をFig.\ref{204704_18Dec14}に示す．作成された地図では，経路は閉じていないものの，重なりは生じていないため，自己位置推定などには問題なく使用できた．作成された地図が歪んでいる原因はオドメトリがずれているためと考えられる．これはオドメトリパラメータの修正や，ジャイロセンサを組み合わせることでオドメトリを高精度化できれば更に高精度な地図を作成できると考えられる．

\begin{figure*}
  \centering
  \includegraphics[width=14cm]{fig/png/gridmap.png}
  \caption{KIT-C3の作成した環境地図(コース全域)}
  \label{204704_18Dec14}
\end{figure*}
\subsection{下方段差検出}
環境地図には存在しない障害物の回避にはROSの local\_planner パッケージを利用したが，下方段差検出における問題が発覚した．
KIT-C3には，下り階段や急激な下り坂への進入を回避するために，地面方向に照射するLRF（下方照射LRF）が搭載されている．ところが，そのような段差で得られる下方照射LRFの生データを local\_planner に入力しても，
段差を回避する経路を獲得できない．この理由は，次に示すlocal\_plannerの仕様とLRFの特性の不一致にあり，具体的には，
1)  local\_planner は地面よりも高い場所に位置する物体を障害物と検知する，すなわち下方照射LRFの出力距離が地面までの距離より小さいことを検知するが，2) 実際には段差において下方照射LRFは地面までの距離よりも大きい距離を出力する，というものである．
つくばチャレンジ2014では正にこの問題のため，段差に進入の直前でロボットを停止させた経緯があった．

そこで今年度は，下方照射LRFが地面までの距離よりも大きい値を出力した場合，それをlocal\_plannerが障害物と認識できる値に人為的な変更を加える機能を追加した．この様子をFig.\ref{lower_step_detector} に示す．

最後に，本機能の工夫点について述べる．下方段差を機能させるためには，ロボット，LRF，地面との位置関係や，環境に合わせたLRFの感度の調整が必要となることが予想されたため，細かくパラメータを調整できる仕様を定めて実装を行った．
これにより，事前の検証において，屋内では段差検出ができたが屋外で検出ができないという問題が発生したが，パラーメータ調整だけでこの問題を容易に解決することができた．

\begin{figure}
    \centering
    \includegraphics[width=8cm]{fig/png/lower_step_detector.png}
    \caption{KIT-C3の下方段差検出}
    \label{lower_step_detector}
\end{figure}

\subsection{遠隔監視システム}
つくばチャレンジの注意事項等について，「ロボットの位置や状況のステーションにおけるモニタリング」を強く推奨すると明記されている．我々は本要求事項を達成する遠隔監視システムを構築したので，その機能とネットワーク環境について述べる．
ただし，本システムは大会当日に機能させることが出来なかったため，以下では開発時の情報を用いて説明する．

初めに，遠隔監視について述べる．監視画面として，ロボットの現在姿勢を地図上に表示させる形式を採用した．現在姿勢，あるいは現在姿勢と経路履歴の両方，を選択的に表示できるようにした．現在姿勢を表示した様子をFig.\ref{monitor}に示す．なお，同図で画像の一部のみを拡大をしている箇所は説明のために加工を施したもので，実際のシステムでは背景の大域地図上にロボットの姿勢が表示されるのみである．
\begin{figure}
    \centering
    \includegraphics[width=6cm]{fig/png/monitor.png}
    \caption{遠隔監視システムで地図上に現在姿勢を表示させた様子．}
    \label{monitor}
\end{figure}

次に，通信環境について述べる．監視端末とロボット間の通信回線として商用モバイル回線を利用し，VPNで接続を行った．VPNシステムとして，OpenVPNを採用した．遠隔監視PCをサーバ，ロボットをクライアントとしてVPNネットワークを構成し，ROS ネットワークと連携させることで，遠隔監視を実現した．

ここで，工夫点について記述する．本システム開発当初，本構成でROSの可視化ツールであるrvizによる監視を試みたところ，rvizはリアルタイムに更新される位置情報を全て取得しようと試みるのだが，商用回線の通信速度ではその情報量に対応しきれず，情報の更新漏れが頻繁に発生してしまった．また，パケット通信容量が膨大で，契約した通信回線の上限を容易に超えてしまう恐れがあり，遠隔監視そのものが実現できなくなる懸念があった．
そこで，ロボットが一定距離を移動する毎に，自身の位置を監視端末に送信する仕様に変更することで，更新漏れとパケット通信料の問題を解決した．検証段階では送信間隔5[m]毎に設定したが，ロボットの位置を追跡するには十分な周期であった．

最後に，本機能の展望を記述する．ネットワークシステムを独自で構築したため，位置に限らず任意の情報を遠隔監視するための基盤技術を確立できた．期待される機能の例として，ロボットの現在速度，電池残量，検出した人物の画像等といった，遠隔監視に有益な情報表示機能が挙げられる．

\section{結果と考察}
\subsection{実験走行}
LRFを2台用いることによって環境地図が安定して作成できるようになったため，一度手動で操作してデータ取りを行った後，すぐに地図作成を完了することができた．また，実験走行では横断歩道手前まで何度か走行できたものの，横断歩道を通過する実験を行うことが出来なかった．横断歩道へ侵入する際の段差が想定よりも大きく，車体が前のめりに傾いた際に地面を障害物として認識してしまっていた．他にも，コース後半の橋を渡ったあとの下り坂でも同様の現象が発生したことがあった．

\subsection{本走行結果}
本走行では雨だったものの，ラップトップPCをビニール袋で覆う以外には特に防水処理は行っていない．LRFが雨を障害物として認識することがあり，頻繁に一時停止するものの，順調に走行し，横断歩道手前までの約1420[m]自律走行を行った．しかし，横断歩道手前で一時停止出来なかったため，オペレータが緊急停止スイッチを押し，停止させた．
横断歩道手前のwaypointに到達したら一時停止するような処理を実装していたが，waypointの位置の設定ミスが原因だった．横断歩道手前での実験が不十分だったことが設定ミスの原因である．

昨年からハードウェア構成やソフトウェア構成をほとんど変更していないものの，地図作成や自己位置推定に用いたLRFを1台から2台に変更し，360度から情報を得ることができるようになったことで格段に安定性を大きくすることが出来た．また，オドメトリの精度向上も自己位置推定の安定性向上につながった．しかしながら，広い場所では自己位置推定が安定しない場合があったため，3DLiDARなどを利用した自己位置推定を利用して解決を図りたい．

また，今回は完走を目標としたため人物発見には取組めていない．次回の参加では人物発見を行い，課題の完全達成を目指したい．


\section{開発状況などに関して}
本年度の開発では，昨年度までに開発してきたロボットを用いたが，本年度の開発期間は大会本走行の約1ヶ月前からであった．更に，開発を行った人数は3名で，開発期間の約半分は2名がKIT-C3に，1名がKIT-C4の開発を行っていた．さらに開発メンバーの一人は，遠隔地におり，実際にロボットが間近にある環境で開発を行う回数は，ほんの数回であった．このような短期間かつ少人数で開発を行う際に，ソフトウェアの仕様統一が行い易いROSの影響は非常に大きかったと言える．また，開発を行う際に，オンラインでソースコードを共有できるGitHubの利用も非常に効果的であった．
開発を行うにあたり，我々のチームは実験走行になかなか参加出来ないため，学内での実験を積み重ねてきた．学内の実験においても約1000[m]程度の自律走行が安定してできていた．しかし，学内での実験では他のロボットや未知の障害物などが少なく，道幅は広く，起伏が殆ど無い環境だったためつくばチャレンジの環境では上手く行かないことがあった．本番前の実験走行ではこの辺りの調整が大変であった．

\section{最後に}
我々が開発したソースコードは，GitHub上で公開している．開発を行うにあたって参考にしていただければありがたい．
\url{http://github.com/Nishida-Lab/TC2015}

\section*{謝辞}
つくばチャレンジ実行委員会やつくば市の方々にはつくばチャレンジのような貴重な実験の機会を与えていただき感謝いたします．



% \begin{thebibliography}{9}% 文献が10以上のとき99，10未満のとき9
 
% \end{thebibliography}

%\appendix
%\section{}


\end{document}
